<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Builder</title>
  <style>
    /* existing CSS unchanged */
    body { font-family: Arial, sans-serif; margin: 0; background-color: #111; color: #fff; }
    header { background-color: #222; padding: 20px; text-align: center; }
    select, button { font-size: 16px; padding: 8px; margin: 10px 5px; }
    .controls { display: flex; flex-direction: column; align-items: center; }
    .pitch-container { display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #004400; }
    .pitch { border: 5px solid white; border-radius: 12px; width: 90%; max-width: 900px; height: 600px; position: relative; background-color: #0a4d0a; display: flex; flex-direction: column; justify-content: space-evenly; }
    .player-row { display: flex; justify-content: center; gap: 10px; }
    .shirt { width: 80px; height: 80px; border-radius: 50%; border: 2px solid white; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 0 6px #000; background-color: #7A263A; color: white; }
    .selector { margin-top: 4px; font-size: 12px; width: 90%; }
    table { margin: 20px auto; width: 80%; border-collapse: collapse; background-color: #eee; color: #000; }
    table, th, td { border: 1px solid #888; }
    th, td { padding: 8px 12px; text-align: center; }
    th { background-color: #ccc; }
  </style>
</head>
<body>
  <header>
    <div class="controls">
      <label for="teamSelect">Select Team:</label>
      <select id="teamSelect"></select>
      <label for="formationSelect">Formation:</label>
      <select id="formationSelect">
        <option>4-4-2</option>
        <option>4-3-3</option>
        <option>3-5-2</option>
        <option>4-2-3-1</option>
        <option>4-1-4-1</option>
        <option>3-4-3</option>
        <option>5-3-2</option>
        <option>4-5-1</option>
        <option>3-6-1</option>
        <option>5-4-1</option>
      </select>
      <div>
        <button onclick="saveTeam()">üíæ Save</button>
        <button onclick="loadTeam()">üìÇ Load</button>
        <button onclick="screenshot()">üñºÔ∏è Screenshot</button>
      </div>
    </div>
  </header>
  <div class="pitch-container">
    <div id="pitch" class="pitch"></div>
  </div>
  <table id="squadTable">
    <thead>
      <tr><th>#</th><th>Name</th><th>Position</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    let teams = [], players = [];
    const formations = {
      "4-4-2": [1, 4, 4, 2],
      "4-3-3": [1, 4, 3, 3],
      "3-5-2": [1, 3, 5, 2],
      "4-2-3-1": [1, 4, 2, 3, 1],
      "4-1-4-1": [1, 4, 1, 4, 1],
      "3-4-3": [1, 3, 4, 3],
      "5-3-2": [1, 5, 3, 2],
      "4-5-1": [1, 4, 5, 1],
      "3-6-1": [1, 3, 6, 1],
      "5-4-1": [1, 5, 4, 1]
    };

    async function loadData() {
      const [teamsRes, playersRes] = await Promise.all([
        fetch('teams.json'), fetch('players.json')
      ]);
      teams = await teamsRes.json();
      players = await playersRes.json();
      populateTeams();
    }

    function populateTeams() {
      const teamSelect = document.getElementById('teamSelect');
      teamSelect.innerHTML = '';
      teams.forEach(t => {
        const option = document.createElement('option');
        option.value = t.team_name; option.textContent = t.team_name;
        teamSelect.appendChild(option);
      });
      teamSelect.addEventListener('change', updatePitch);
      document.getElementById('formationSelect')
        .addEventListener('change', updatePitch);
      updatePitch();
    }

    function getPositionType(index, total) {
      // same logic as before
    }

    function updatePitch() {
      const team = document.getElementById('teamSelect').value;
      const formation = document.getElementById('formationSelect').value;
      const teamData = teams.find(t => t.team_name === team);
      const pitch = document.getElementById('pitch');
      pitch.innerHTML = '';
      if (!teamData) return;
      pitch.style.backgroundColor = teamData.primary_color;
      pitch.style.color = teamData.secondary_color;

      const tbody = document.querySelector('#squadTable tbody');
      tbody.innerHTML = '';

      const lineCounts = formations[formation];
      let playerNum = 1;

      lineCounts.forEach((count, lineIndex) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'player-row';
        const pos = getPositionType(lineIndex, lineCounts.length);
        const teamPlayers = players.filter(p => p.team === team && p.position === pos)
                                  .sort((a,b) => a.player_name.split(' ').pop()
                                  .localeCompare(b.player_name.split(' ').pop()));
        for (let j = 0; j < count; j++) {
          const shirt = document.createElement('div');
          shirt.className = 'shirt';
          shirt.innerHTML = `<div>${playerNum}</div>`;
          const sel = document.createElement('select');
          sel.className = 'selector';
          sel.dataset.num = playerNum;
          sel.dataset.pos = pos;
          sel.innerHTML = '<option value="">Select</option>' +
            teamPlayers.map(p => `<option value="${p.player_name}">${p.player_name}</option>`).join('');
          sel.addEventListener('change', updateSelections);
          shirt.appendChild(sel);
          rowDiv.appendChild(shirt);
          playerNum++;
        }
        pitch.appendChild(rowDiv);
      });
      updateSelections();
    }

    function updateSelections() {
      const tbody = document.querySelector('#squadTable tbody');
      tbody.innerHTML = '';

      // Gather selections
      const selections = Array.from(document.querySelectorAll('.selector'))
        .map(s => ({ num: parseInt(s.dataset.num), name: s.value, pos: s.dataset.pos }))
        .filter(s => s.name);

      // Sort by position order then by number
      const order = { GK: 1, DEF: 2, MID: 3, FWD: 4 };
      selections.sort((a, b) => order[a.pos] - order[b.pos] || a.num - b.num);

      // Populate table with all selections
      selections.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.num}</td><td>${s.name}</td><td>${s.pos}</td>`;
        tbody.appendChild(tr);
      });

      // Disable already-selected options in other selectors
      const selectedNames = selections.map(s => s.name);
      document.querySelectorAll('.selector').forEach(sel => {
        sel.querySelectorAll('option').forEach(opt => {
          if (opt.value && selectedNames.includes(opt.value) && sel.value !== opt.value) {
            opt.disabled = true;
          } else {
            opt.disabled = false;
          }
        });
      });
    }

    function saveTeam() {
      // unchanged
    }

    function loadTeam() {
      // unchanged, but ensure it calls updateSelections after setting
      // selectors
    }

    function screenshot() {
      alert("Use your device's screenshot feature.");
    }

    loadData();
  </script>
</body>
</html>

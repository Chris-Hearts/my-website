<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Builder</title>
  <!-- suppress default favicon requests -->
  <link rel="icon" href="data:," />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #111; color: #fff; }
    header { background-color: #222; padding: 20px; text-align: center; }
    select, button { font-size: 16px; padding: 8px; margin: 10px 5px; }
    .controls { display: flex; flex-direction: column; align-items: center; }
    .pitch-container { display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #004400; }
    .pitch { border: 5px solid white; border-radius: 12px; width: 90%; max-width: 900px; height: 600px; position: relative; background-color: #0a4d0a; display: flex; flex-direction: column; justify-content: space-evenly; }
    .player-row { display: flex; justify-content: center; gap: 10px; }
    .shirt { width: 80px; height: 80px; border-radius: 50%; border: 2px solid white; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 0 6px #000; background-color: #7A263A; color: white; }
    .selector {
      margin-top: 4px;
      font-size: 14px;
      width: 100%;
      max-width: 120px;
      padding: 8px 32px 8px 12px;
      border-radius: 6px;
      border: none;
      background-color: rgba(255,255,255,0.9);
      color: #000;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='5'><path fill='%23000' d='M0,0 L10,0 L5,5 Z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 10px center;
      cursor: pointer;
    }
    table { margin: 20px auto; width: 80%; border-collapse: collapse; background-color: #eee; color: #000; }
    table, th, td { border: 1px solid #888; }
    th, td { padding: 8px 12px; text-align: center; }
    th { background-color: #ccc; }
  </style>
</head>
<body>
  <header>
    <div class="controls">
      <label for="teamSelect">Select Team:</label>
      <select id="teamSelect"></select>
      <label for="formationSelect">Formation:</label>
      <select id="formationSelect">
        <option>4-4-2</option>
        <option>4-3-3</option>
        <option>3-5-2</option>
        <option>4-2-3-1</option>
        <option>4-1-4-1</option>
        <option>3-4-3</option>
        <option>5-3-2</option>
        <option>4-5-1</option>
        <option>3-6-1</option>
        <option>5-4-1</option>
      </select>
      <div>
        <button onclick="saveTeam()">üíæ Save</button>
        <button onclick="loadTeam()">üìÇ Load</button>
        <button onclick="screenshot()">üñºÔ∏è Screenshot</button>
      </div>
    </div>
  </header>
  <div class="pitch-container">
    <div id="pitch" class="pitch"></div>
  </div>
  <table id="squadTable">
    <thead>
      <tr><th>#</th><th>Name</th><th>Position</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    let teams = [], players = [];
    const formations = {
      "4-4-2": [1, 4, 4, 2],
      "4-3-3": [1, 4, 3, 3],
      "3-5-2": [1, 3, 5, 2],
      "4-2-3-1": [1, 4, 2, 3, 1],
      "4-1-4-1": [1, 4, 1, 4, 1],
      "3-4-3": [1, 3, 4, 3],
      "5-3-2": [1, 5, 3, 2],
      "4-5-1": [1, 4, 5, 1],
      "3-6-1": [1, 3, 6, 1],
      "5-4-1": [1, 5, 4, 1]
    };

    async function loadData() {
      const [teamsRes, playersRes] = await Promise.all([
        fetch('teams.json'), fetch('players.json')
      ]);
      teams = await teamsRes.json();
      players = await playersRes.json();
      populateTeams();
    }

    function populateTeams() {
      const teamSelect = document.getElementById('teamSelect');
      teamSelect.innerHTML = '';
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.team_name;
        opt.textContent = t.team_name;
        teamSelect.appendChild(opt);
      });
      // default to first team
      if (teams.length) teamSelect.value = teams[0].team_name;
      document.getElementById('formationSelect')
        .addEventListener('change', updatePitch);
      teamSelect.addEventListener('change', updatePitch);
      updatePitch();
    }

    function getPositionType(index, total) {
      if (index === 0) return 'GK';
      if (total === 5) {
        if (index === 1) return 'DEF';
        if (index === 2 || index === 3) return 'MID';
        if (index === 4) return 'FWD';
      } else if (total === 4) {
        if (index === 1) return 'DEF';
        if (index === 2) return 'MID';
        if (index === 3) return 'FWD';
      } else if (total === 3) {
        if (index === 1) return 'DEF';
        if (index === 2) return 'FWD';
      }
      return 'MID';
    }

    function updatePitch() {
      const team = document.getElementById('teamSelect').value;
      const formation = document.getElementById('formationSelect').value;
      const teamData = teams.find(t => t.team_name === team);
      const pitch = document.getElementById('pitch');
      pitch.innerHTML = '';
      if (!teamData) return;
      pitch.style.backgroundColor = teamData.primary_color;
      pitch.style.color = teamData.secondary_color;

      const tbody = document.querySelector('#squadTable tbody');
      tbody.innerHTML = '';

      const lineCounts = formations[formation] || [];
      let playerNum = 1;

      lineCounts.forEach((count, i) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'player-row';
        const pos = getPositionType(i, lineCounts.length);
        const teamPlayers = players
          .filter(p => p.team === team && p.position === pos)
          .sort((a, b) => a.player_name.split(' ').pop()
            .localeCompare(b.player_name.split(' ').pop()));
        for (let j = 0; j < count; j++) {
          const shirt = document.createElement('div');
          shirt.className = 'shirt';
          shirt.innerHTML = `<div>${playerNum}</div>`;
          const sel = document.createElement('select');
          sel.className = 'selector';
          sel.dataset.num = playerNum;
          sel.dataset.pos = pos;
          sel.innerHTML = '<option value="">Select</option>' +
            teamPlayers.map(p => `<option value="${p.player_name}">${p.player_name}</option>`).join('');
          sel.addEventListener('change', updateSelections);
          shirt.appendChild(sel);
          rowDiv.appendChild(shirt);
          playerNum++;
        }
        pitch.appendChild(rowDiv);
      });
      updateSelections();
    }

    function updateSelections() {
      const tbody = document.querySelector('#squadTable tbody');
      tbody.innerHTML = '';
      const selections = Array.from(document.querySelectorAll('.selector'))
        .map(s => ({ num: +s.dataset.num, name: s.value, pos: s.dataset.pos }))
        .filter(s => s.name);
      const order = { GK: 1, DEF: 2, MID: 3, FWD: 4 };
      selections.sort((a, b) => order[a.pos] - order[b.pos] || a.num - b.num);
      selections.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.num}</td><td>${s.name}</td><td>${s.pos}</td>`;
        tbody.appendChild(tr);
      });
      const selectedNames = selections.map(s => s.name);
      document.querySelectorAll('.selector').forEach(sel => {
        sel.querySelectorAll('option').forEach(opt => {
          opt.disabled = (!!opt.value && selectedNames.includes(opt.value) && sel.value !== opt.value);
        });
      });
    }

    function saveTeam() {
      const team = document.getElementById('teamSelect').value;
      const formation = document.getElementById('formationSelect').value;
      const squad = Array.from(document.querySelectorAll('.selector')).map(s => s.value);
      localStorage.setItem('savedTeam', JSON.stringify({ team, formation, squad }));
      alert('Team saved!');
    }

    function loadTeam() {
      const saved = JSON.parse(localStorage.getItem('savedTeam'));
      if (!saved) return alert('No saved team');
      document.getElementById('teamSelect').value = saved.team;
      document.getElementById('formationSelect').value = saved.formation;
      updatePitch();
      setTimeout(() => {
        document.querySelectorAll('.selector').forEach((sel, i) => sel.value = saved.squad[i] || '');
        document.querySelectorAll('.selector').forEach(sel => sel.dispatchEvent(new Event('change')));
      }, 50);
    }

    function screenshot() {
      alert("Use your device's screenshot feature.");
    }

    loadData();
  </script>
</body>
</html>

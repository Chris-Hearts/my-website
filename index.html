<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Team Builder: Hearts & Scotland</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  body { margin:0; font-family:sans-serif; background:#222; color:#fff; }
  header, footer { text-align:center; padding:10px; }
  select, button { padding:6px; font-size:14px; margin:5px; }
  #pitch { max-width:800px; margin:20px auto; position:relative; border:5px solid #fff; border-radius:12px; }
  .player-row { display:flex; justify-content:center; margin:15px 0; }
  .shirt { width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; color:#fff; border:2px solid #fff; cursor:pointer; position:relative;}
  .shirt:hover { transform:scale(1.1); }
  #logo { width:80px; position:absolute; top:10px; left:10px; opacity:0.7; }
</style>
</head>
<body>

<header>
  <select id="teamSelect"></select>
  <select id="formation">
    <option>4-4-2</option>
    <option>4-3-3</option>
    <option>3-5-2</option>
    <option>4-2-3-1</option>
  </select>
</header>

<div id="pitch"></div>

<footer>
  Team builder - select your squad!
</footer>

<script>
const formations = {
  "4-4-2": [1,4,4,2],
  "4-3-3": [1,4,3,3],
  "3-5-2": [1,3,5,2],
  "4-2-3-1": [1,4,2,3,1]
};

let teams = {}, players = [], currentTeam = {}, selectedPlayers = new Set();

function loadCSV(url, callback) {
  Papa.parse(url, {
    download: true,
    header: true,
    complete: results => callback(results.data)
  });
}

function setup() {
  loadCSV('teams.csv', data => {
    data.forEach(row => {
      teams[row.team_name] = {
        color: row.primary_color,
        secondary: row.secondary_color,
        logo: row.logo_url
      };
    });
    buildTeamDropdown();
  });
  loadCSV('players.csv', data => {
    players = data;
  });
}

function buildTeamDropdown() {
  const sel = document.getElementById('teamSelect');
  sel.innerHTML = Object.keys(teams).map(t => `<option>${t}</option>`).join('');
  sel.onchange = () => {
    currentTeam = teams[sel.value];
    buildPitch();
  };
  sel.value = "Hearts";
  currentTeam = teams["Hearts"];
  buildPitch();
}

function buildPitch() {
  selectedPlayers = new Set();
  const pitch = document.getElementById('pitch');
  pitch.style.background = currentTeam.color;
  pitch.innerHTML = `<img id="logo" src="${currentTeam.logo}">`;
  const formation = formations[document.getElementById('formation').value];
  formation.forEach((count, idx) => {
    const row = document.createElement('div');
    row.className = 'player-row';
    for(let i=0; i<count; i++) {
      const div = document.createElement('div');
      div.className = 'shirt';
      div.style.background = currentTeam.color;
      div.onclick = () => showDropdown(div, idx, formation.length);
      div.innerHTML = '?';
      row.appendChild(div);
    }
    pitch.appendChild(row);
  });
}

function showDropdown(shirt, lineIndex, totalLines) {
  const pos = getPositionForLine(lineIndex, totalLines);
  const teamPlayers = players.filter(p => p.team === document.getElementById('teamSelect').value && p.position === pos && !selectedPlayers.has(p.player_name));
  const sel = document.createElement('select');
  sel.innerHTML = `<option>Select ${pos}</option>` + teamPlayers.map(p => `<option>${p.player_name}</option>`).join('');
  sel.onchange = () => {
    if (shirt.dataset.player) selectedPlayers.delete(shirt.dataset.player);
    shirt.dataset.player = sel.value;
    shirt.innerHTML = sel.value;
    selectedPlayers.add(sel.value);
    shirt.removeChild(sel);
  };
  shirt.innerHTML = '';
  shirt.appendChild(sel);
}

function getPositionForLine(idx, total) {
  if (idx === 0) return "GK";
  if (idx === total -1) return "FWD";
  return "MID";
}

document.getElementById('formation').onchange = buildPitch;

setup();
</script>
</body>
</html>
